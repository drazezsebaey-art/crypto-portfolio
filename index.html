<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متتبع محفظة العملات الرقمية</title>
    <!-- للاختبار فقط: يُفضل تثبيت Tailwind محليًا في الإنتاج باستخدام PostCSS أو Tailwind CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- منع طلبات 404 لـ favicon -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        body { font-family: 'Arial', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-glow { box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .card-glow:hover { box-shadow: 0 8px 30px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 300px; text-align: right; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white py-8">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl font-bold text-center mb-2">متتبع محفظة العملات الرقمية</h1>
            <p class="text-center text-blue-100">تتبع استثماراتك بالوقت الفعلي (بيانات من CoinGecko)</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- إدارة المحافظ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">إدارة المحافظ</h2>
                <button onclick="createPortfolio()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    محفظة جديدة
                </button>
            </div>
            
            <div class="flex space-x-2 space-x-reverse mb-4">
                <select id="portfolioSelect" onchange="switchPortfolio()" class="flex-1 p-3 border rounded-lg">
                    <option value="">اختر المحفظة</option>
                </select>
                <button onclick="deletePortfolio()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    حذف المحفظة
                </button>
            </div>
            <!-- حقل إدخال الاستثمار الابتدائي -->
            <div class="flex space-x-2 space-x-reverse">
                <input type="number" id="initialInvestmentInput" placeholder="إجمالي الاستثمار الابتدائي" step="0.01" class="flex-1 p-3 border rounded-lg">
                <button onclick="updateInitialInvestment()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    تحديث الاستثمار الابتدائي
                </button>
            </div>
        </div>

        <!-- ملخص المحفظة -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">إجمالي القيمة</h3>
                <p class="text-3xl font-bold text-blue-600" id="totalValue">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">إجمالي الاستثمار الابتدائي</h3>
                <p class="text-3xl font-bold text-gray-800" id="initialInvestment">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">أداء العملات</h3>
                <p class="text-3xl font-bold" id="coinPerformance">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">نسبة الأداء العام</h3>
                <p class="text-3xl font-bold" id="overallPerformancePercent">0.00%</p>
            </div>
        </div>

        <!-- أداء المحافظ المجمعة -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">إجمالي الاستثمار الابتدائي (المجمع)</h3>
                <p class="text-3xl font-bold text-gray-800" id="aggregatedInitialInvestment">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">إجمالي القيمة الحالية (المجمع)</h3>
                <p class="text-3xl font-bold text-blue-600" id="aggregatedTotalValue">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">الربح/الخسارة الإجمالي</h3>
                <p class="text-3xl font-bold" id="aggregatedProfit">$0.00</p>
            </div>
        </div>

        <!-- إضافة عملة جديدة -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">إضافة عملة جديدة</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="coinSymbol" placeholder="رمز العملة (bitcoin, ethereum, etc.)" 
                       class="p-3 border rounded-lg" style="text-transform: lowercase;">
                <input type="number" id="coinAmount" placeholder="الكمية" step="0.00000001" class="p-3 border rounded-lg">
                <input type="number" id="coinPrice" placeholder="سعر الشراء" step="0.01" class="p-3 border rounded-lg">
                <button onclick="addCoin()" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition-colors">
                    إضافة العملة
                </button>
            </div>
        </div>

        <!-- جدول العملات -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">محفظة العملات</h2>
                <div class="flex items-center">
                    <span id="lastUpdate" class="text-sm text-gray-500 ml-4"></span>
                    <button onclick="updatePrices()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        تحديث الأسعار
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">العملة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">سعر الشراء</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر الحالي</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">القيمة الحالية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الربح/الخسارة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النسبة %</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="coinTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                لا توجد عملات في المحفظة. أضف عملة جديدة للبدء.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- نافذة تعديل العملة -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">تعديل العملة</h3>
                <input type="hidden" id="editSymbol">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">الكمية</label>
                    <input type="number" id="editAmount" step="0.00000001" class="w-full p-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">سعر الشراء</label>
                    <input type="number" id="editBuyPrice" step="0.01" class="w-full p-2 border rounded-lg">
                </div>
                <button onclick="saveEdit()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">حفظ</button>
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-700 ml-2">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        let portfolios = {};
        let currentPortfolio = null;
        let priceCache = {};
        let updateInterval;

        window.onload = function() {
            if (document.getElementById('portfolioSelect')) {
                loadPortfolios();
                createDefaultPortfolio();
            } else {
                console.error('العنصر portfolioSelect غير موجود في الصفحة');
            }
        };

        function loadPortfolios() {
            const saved = JSON.parse(localStorage.getItem('cryptoPortfolios') || '{}');
            portfolios = saved;
            updatePortfolioSelect();
        }

        function savePortfolios() {
            localStorage.setItem('cryptoPortfolios', JSON.stringify(portfolios));
        }

        function createDefaultPortfolio() {
            if (Object.keys(portfolios).length === 0) {
                const defaultId = 'portfolio_1';
                const initialValue = parseFloat(prompt('أدخل إجمالي الاستثمار الابتدائي (اختياري، اتركه فارغًا ليبدأ من 0):') || '0');
                if (isNaN(initialValue) || initialValue < 0) {
                    alert('القيمة الابتدائية يجب أن تكون رقمًا صالحًا أو صفر');
                    return createDefaultPortfolio();
                }
                portfolios[defaultId] = {
                    name: 'المحفظة الرئيسية',
                    coins: {},
                    created: new Date().toISOString(),
                    initialValue: initialValue
                };
                currentPortfolio = defaultId;
                savePortfolios();
                updatePortfolioSelect();
                if (document.getElementById('portfolioSelect')) {
                    document.getElementById('portfolioSelect').value = defaultId;
                }
                document.getElementById('initialInvestmentInput').value = initialValue;
            } else {
                currentPortfolio = Object.keys(portfolios)[0];
                if (document.getElementById('portfolioSelect')) {
                    document.getElementById('portfolioSelect').value = currentPortfolio;
                }
                document.getElementById('initialInvestmentInput').value = portfolios[currentPortfolio].initialValue || '';
            }
            displayCoins();
            updateAggregatedPerformance();
        }

        function createPortfolio() {
            const name = prompt('اسم المحفظة الجديدة:');
            if (name && name.trim()) {
                const initialValue = parseFloat(prompt('أدخل إجمالي الاستثمار الابتدائي (اختياري، اتركه فارغًا ليبدأ من 0):') || '0');
                if (isNaN(initialValue) || initialValue < 0) {
                    alert('القيمة الابتدائية يجب أن تكون رقمًا صالحًا أو صفر');
                    return;
                }
                const id = 'portfolio_' + Date.now();
                portfolios[id] = {
                    name: name.trim(),
                    coins: {},
                    created: new Date().toISOString(),
                    initialValue: initialValue
                };
                currentPortfolio = id;
                savePortfolios();
                updatePortfolioSelect();
                if (document.getElementById('portfolioSelect')) {
                    document.getElementById('portfolioSelect').value = id;
                }
                document.getElementById('initialInvestmentInput').value = initialValue;
                displayCoins();
                updateAggregatedPerformance();
            }
        }

        function deletePortfolio() {
            if (!currentPortfolio) return;
            if (Object.keys(portfolios).length === 1) {
                alert('لا يمكن حذف المحفظة الوحيدة المتبقية');
                return;
            }
            const portfolioName = portfolios[currentPortfolio].name;
            if (confirm(`هل أنت متأكد من حذف محفظة "${portfolioName}"؟`)) {
                delete portfolios[currentPortfolio];
                currentPortfolio = Object.keys(portfolios)[0] || null;
                savePortfolios();
                updatePortfolioSelect();
                document.getElementById('initialInvestmentInput').value = currentPortfolio ? portfolios[currentPortfolio].initialValue || '' : '';
                if (currentPortfolio && document.getElementById('portfolioSelect')) {
                    document.getElementById('portfolioSelect').value = currentPortfolio;
                    displayCoins();
                }
                updateAggregatedPerformance();
            }
        }

        function updatePortfolioSelect() {
            const select = document.getElementById('portfolioSelect');
            if (!select) {
                console.error('العنصر portfolioSelect غير موجود');
                return;
            }
            select.innerHTML = '<option value="">اختر المحفظة</option>';
            Object.keys(portfolios).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = portfolios[id].name;
                select.appendChild(option);
            });
        }

        function switchPortfolio() {
            const selected = document.getElementById('portfolioSelect').value;
            if (selected && portfolios[selected]) {
                currentPortfolio = selected;
                document.getElementById('initialInvestmentInput').value = portfolios[currentPortfolio].initialValue || '';
                displayCoins();
            } else {
                document.getElementById('initialInvestmentInput').value = '';
            }
        }

        function addCoin() {
            if (!currentPortfolio) {
                alert('يرجى اختيار محفظة أولاً');
                return;
            }
            const symbol = document.getElementById('coinSymbol').value.toLowerCase().trim();
            const amount = parseFloat(document.getElementById('coinAmount').value);
            const buyPrice = parseFloat(document.getElementById('coinPrice').value);
            if (!symbol || isNaN(amount) || isNaN(buyPrice) || amount <= 0 || buyPrice <= 0) {
                alert('يرجى ملء جميع الحقول بقيم صالحة');
                return;
            }
            const portfolio = portfolios[currentPortfolio];
            if (portfolio.coins[symbol]) {
                const existing = portfolio.coins[symbol];
                const totalValue = (existing.amount * existing.buyPrice) + (amount * buyPrice);
                const totalAmount = existing.amount + amount;
                portfolio.coins[symbol] = {
                    amount: totalAmount,
                    buyPrice: totalValue / totalAmount,
                    currentPrice: existing.currentPrice || 0
                };
            } else {
                portfolio.coins[symbol] = {
                    amount: amount,
                    buyPrice: buyPrice,
                    currentPrice: 0
                };
            }
            savePortfolios();
            displayCoins();
            updateAggregatedPerformance();
            document.getElementById('coinSymbol').value = '';
            document.getElementById('coinAmount').value = '';
            document.getElementById('coinPrice').value = '';
            updatePrices(); // تحديث الأسعار بعد إضافة عملة
        }

        function removeCoin(symbol) {
            if (!currentPortfolio) return;
            if (confirm(`هل أنت متأكد من حذف ${symbol}؟`)) {
                delete portfolios[currentPortfolio].coins[symbol];
                savePortfolios();
                displayCoins();
                updateAggregatedPerformance();
            }
        }

        function displayCoins() {
            if (!currentPortfolio || !portfolios[currentPortfolio]) {
                document.getElementById('coinTableBody').innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">يرجى اختيار محفظة صالحة</td></tr>';
                updateSummary();
                return;
            }
            const coins = portfolios[currentPortfolio].coins;
            const tbody = document.getElementById('coinTableBody');
            if (Object.keys(coins).length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">لا توجد عملات في المحفظة</td></tr>';
                updateSummary();
                return;
            }
            tbody.innerHTML = '';
            Object.keys(coins).forEach(symbol => {
                const coin = coins[symbol];
                const currentValue = coin.amount * coin.currentPrice;
                const investedValue = coin.amount * coin.buyPrice;
                const pnl = currentValue - investedValue;
                const pnlPercent = investedValue > 0 ? (pnl / investedValue * 100) : 0;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const priceChangeClass = coin.currentPrice >= coin.buyPrice ? 'price-up' : 'price-down';
                const pnlClass = pnl >= 0 ? 'text-green-600' : 'text-red-600';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${symbol}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${coin.amount.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${coin.buyPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${priceChangeClass}">
                        ${coin.currentPrice > 0 ? 
                            `$${coin.currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}` : 
                            '<span class="pulse">جاري التحديث...</span>'
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${currentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${pnlClass}">
                        $${pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${pnlClass}">
                        ${pnl >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editCoin('${symbol}')" class="text-yellow-600 hover:text-yellow-900 mr-2 transition-colors">تعديل</button>
                        <button onclick="removeCoin('${symbol}')" class="text-red-600 hover:text-red-900 transition-colors">حذف</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            updateSummary();
            updateAggregatedPerformance();
        }

        function updateSummary() {
            if (!currentPortfolio) return;
            const portfolio = portfolios[currentPortfolio];
            const coins = portfolio.coins;
            let totalCurrentValue = 0;
            let totalCoinInvestment = 0;
            Object.keys(coins).forEach(symbol => {
                const coin = coins[symbol];
                totalCurrentValue += coin.amount * coin.currentPrice;
                totalCoinInvestment += coin.amount * coin.buyPrice;
            });
            const initialValue = portfolio.initialValue || 0;
            const coinPerformance = totalCurrentValue - totalCoinInvestment;
            const overallPerformance = totalCurrentValue - initialValue;
            const overallPerformancePercent = initialValue > 0 ? (overallPerformance / initialValue * 100) : 0;
            document.getElementById('totalValue').textContent = `$${totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('initialInvestment').textContent = `$${initialValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            const coinPerfElement = document.getElementById('coinPerformance');
            const overallPerfPercentElement = document.getElementById('overallPerformancePercent');
            coinPerfElement.textContent = `$${coinPerformance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            overallPerfPercentElement.textContent = `${overallPerformance >= 0 ? '+' : ''}${overallPerformancePercent.toFixed(2)}%`;
            const coinPerfClass = coinPerformance >= 0 ? 'text-green-600' : 'text-red-600';
            const overallPerfClass = overallPerformance >= 0 ? 'text-green-600' : 'text-red-600';
            coinPerfElement.className = `text-3xl font-bold ${coinPerfClass}`;
            overallPerfPercentElement.className = `text-3xl font-bold ${overallPerfClass}`;
        }

        function updateInitialInvestment() {
            if (!currentPortfolio) {
                alert('يرجى اختيار محفظة أولاً');
                return;
            }
            const initialInvestmentInput = parseFloat(document.getElementById('initialInvestmentInput').value);
            if (isNaN(initialInvestmentInput) || initialInvestmentInput < 0) {
                alert('يرجى إدخال قيمة صالحة للاستثمار الابتدائي');
                return;
            }
            portfolios[currentPortfolio].initialValue = initialInvestmentInput;
            savePortfolios();
            displayCoins();
            document.getElementById('initialInvestmentInput').value = '';
        }

        function getCoinId(symbol) {
            const coinMap = {
                'bitcoin': 'bitcoin',
                'ethereum': 'ethereum',
                'usdt': 'tether',
                'sol': 'solana',
                'sui': 'sui',
                'avax': 'avalanche-2',
                'sei': 'sei-network',
                'render': 'render-token',
                'icp': 'internet-computer',
                'fet': 'fetch-ai',
                'bnb': 'binancecoin',
                'xrp': 'ripple',
                'ada': 'cardano',
                'doge': 'dogecoin',
                'dot': 'polkadot',
                'matic': 'matic-network',
                'shib': 'shiba-inu',
                'ltc': 'litecoin',
                'uni': 'uniswap',
                'link': 'chainlink',
                'atom': 'cosmos',
                'xlm': 'stellar',
                'bch': 'bitcoin-cash',
                'algo': 'algorand',
                'vet': 'vechain',
                'fil': 'filecoin',
                'trx': 'tron',
                'etc': 'ethereum-classic',
                'xmr': 'monero',
                'ape': 'apecoin',
                'near': 'near',
                'hbar': 'hedera-hashgraph',
                'flow': 'flow',
                'mana': 'decentraland',
                'sand': 'the-sandbox',
                'theta': 'theta-token',
                'xtz': 'tezos',
                'egld': 'elrond-erd-2',
                'usdc': 'usd-coin',
                'busd': 'binance-usd',
                'dai': 'dai',
                'pepe': 'pepe',
                'arb': 'arbitrum',
                'op': 'optimism'
            };
            const mappedId = coinMap[symbol.toLowerCase()];
            if (!mappedId) {
                console.warn(`معرف غير مدعوم للرمز ${symbol}, يتم استخدام الرمز كما هو`);
            }
            return mappedId || symbol.toLowerCase();
        }

        async function updateCoinPrice(symbol) {
            if (!currentPortfolio) return;
            try {
                const coinId = getCoinId(symbol);
                const proxyUrl = 'https://corsproxy.io/?';
                const response = await fetch(`${proxyUrl}${encodeURIComponent(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd&include_24hr_change=true`)}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (data[coinId] && typeof data[coinId].usd === 'number') {
                    portfolios[currentPortfolio].coins[symbol].currentPrice = data[coinId].usd;
                } else {
                    console.error(`خطأ في جلب سعر ${symbol}:`, data);
                    portfolios[currentPortfolio].coins[symbol].currentPrice = 0;
                }
                savePortfolios();
                displayCoins();
            } catch (error) {
                console.error(`خطأ في تحديث سعر ${symbol}:`, error);
                portfolios[currentPortfolio].coins[symbol].currentPrice = 0;
            }
        }

        async function updatePrices() {
            if (!currentPortfolio) return;
            const coins = portfolios[currentPortfolio].coins;
            const symbols = Object.keys(coins);
            if (symbols.length === 0) {
                document.getElementById('lastUpdate').textContent = 'لا توجد عملات لتحديث الأسعار';
                return;
            }
            document.getElementById('lastUpdate').innerHTML = '<div class="loading-spinner"></div>جاري التحديث...';
            try {
                const coinIds = symbols.map(symbol => getCoinId(symbol)).join(',');
                const proxyUrl = 'https://corsproxy.io/?';
                const response = await fetch(`${proxyUrl}${encodeURIComponent(`https://api.coingecko.com/api/v3/simple/price?ids=${coinIds}&vs_currencies=usd&include_24hr_change=true`)}`);
                if (!response.ok) {
                    if (response.status === 429) {
                        console.warn('تم الوصول إلى حد الطلبات (429). جاري المحاولة مرة أخرى بعد 10 ثوانٍ...');
                        await new Promise(resolve => setTimeout(resolve, 10000)); // إعادة محاولة بعد 10 ثوانٍ
                        return updatePrices(); // إعادة المحاولة
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                symbols.forEach(symbol => {
                    const coinId = getCoinId(symbol);
                    if (data[coinId] && typeof data[coinId].usd === 'number') {
                        portfolios[currentPortfolio].coins[symbol].currentPrice = data[coinId].usd;
                    } else {
                        console.error(`خطأ في جلب سعر ${symbol}:`, data);
                        portfolios[currentPortfolio].coins[symbol].currentPrice = 0;
                    }
                });
                savePortfolios();
                displayCoins();
                const now = new Date();
                document.getElementById('lastUpdate').textContent = `آخر تحديث: ${now.toLocaleTimeString('ar-SA')}`;
            } catch (error) {
                console.error('خطأ في تحديث الأسعار:', error);
                document.getElementById('lastUpdate').textContent = 'خطأ في تحديث الأسعار';
            }
        }

        function editCoin(symbol) {
            const coin = portfolios[currentPortfolio].coins[symbol];
            document.getElementById('editSymbol').value = symbol;
            document.getElementById('editAmount').value = coin.amount;
            document.getElementById('editBuyPrice').value = coin.buyPrice;
            document.getElementById('editModal').style.display = 'flex';
        }

        function saveEdit() {
            const symbol = document.getElementById('editSymbol').value;
            const newAmount = parseFloat(document.getElementById('editAmount').value);
            const newBuyPrice = parseFloat(document.getElementById('editBuyPrice').value);
            if (isNaN(newAmount) || isNaN(newBuyPrice) || newAmount <= 0 || newBuyPrice <= 0) {
                alert('يرجى إدخال قيم صالحة للكمية وسعر الشراء');
                return;
            }
            const portfolio = portfolios[currentPortfolio];
            portfolio.coins[symbol] = {
                amount: newAmount,
                buyPrice: newBuyPrice,
                currentPrice: portfolio.coins[symbol].currentPrice || 0
            };
            savePortfolios();
            displayCoins();
            updateAggregatedPerformance();
            closeModal();
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editAmount').value = '';
            document.getElementById('editBuyPrice').value = '';
        }

        function updateAggregatedPerformance() {
            let totalInitialInvestment = 0;
            let totalCurrentValue = 0;
            Object.keys(portfolios).forEach(id => {
                const portfolio = portfolios[id];
                const coins = portfolio.coins;
                let portfolioCurrentValue = 0;
                Object.keys(coins).forEach(symbol => {
                    const coin = coins[symbol];
                    portfolioCurrentValue += coin.amount * coin.currentPrice;
                });
                totalInitialInvestment += portfolio.initialValue || 0;
                totalCurrentValue += portfolioCurrentValue;
            });
            const aggregatedProfit = totalCurrentValue - totalInitialInvestment;
            document.getElementById('aggregatedInitialInvestment').textContent = `$${totalInitialInvestment.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('aggregatedTotalValue').textContent = `$${totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('aggregatedProfit').textContent = `$${aggregatedProfit.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            const profitClass = aggregatedProfit >= 0 ? 'text-green-600' : 'text-red-600';
            document.getElementById('aggregatedProfit').className = `text-3xl font-bold ${profitClass}`;
        }

        // زيادة فترة التحديث إلى 2 دقيقة
        setInterval(() => {
            if (currentPortfolio && Object.keys(portfolios[currentPortfolio].coins).length > 0) {
                updatePrices();
            }
        }, 120000); // 2 دقيقة

        setTimeout(() => {
            if (currentPortfolio) {
                updatePrices();
            }
        }, 2000);
    </script>
</body>
</html>
