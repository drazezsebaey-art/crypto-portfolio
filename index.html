<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متتبع محفظة العملات الرقمية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Arial', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-glow {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card-glow:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white py-8">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl font-bold text-center mb-2">متتبع محفظة العملات الرقمية</h1>
            <p class="text-center text-blue-100">تتبع استثماراتك بالوقت الفعلي</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- إدارة المحافظ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">إدارة المحافظ</h2>
                <button onclick="createPortfolio()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    محفظة جديدة
                </button>
            </div>
            
            <div class="flex space-x-2 space-x-reverse mb-4">
                <select id="portfolioSelect" onchange="switchPortfolio()" class="flex-1 p-3 border rounded-lg">
                    <option value="">اختر المحفظة</option>
                </select>
                <button onclick="deletePortfolio()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    حذف المحفظة
                </button>
            </div>
            <!-- حقل إدخال الاستثمار الابتدائي -->
            <div class="flex space-x-2 space-x-reverse">
                <input type="number" id="initialInvestmentInput" placeholder="إجمالي الاستثمار الابتدائي" step="0.01" class="flex-1 p-3 border rounded-lg">
                <button onclick="updateInitialInvestment()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    تحديث الاستثمار الابتدائي
                </button>
            </div>
        </div>

        <!-- ملخص المحفظة -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">إجمالي القيمة</h3>
                <p class="text-3xl font-bold text-blue-600" id="totalValue">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">إجمالي الاستثمار الابتدائي</h3>
                <p class="text-3xl font-bold text-gray-800" id="initialInvestment">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">أداء العملات</h3>
                <p class="text-3xl font-bold" id="coinPerformance">$0.00</p>
            </div>
            <div class="bg-white rounded-lg p-6 card-glow">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">نسبة الأداء العام</h3>
                <p class="text-3xl font-bold" id="overallPerformancePercent">0.00%</p>
            </div>
        </div>

        <!-- إضافة عملة جديدة -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">إضافة عملة جديدة</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="coinSymbol" placeholder="رمز العملة (BTC, ETH, etc.)" 
                       class="p-3 border rounded-lg" style="text-transform: uppercase;">
                <input type="number" id="coinAmount" placeholder="الكمية" step="0.00000001" class="p-3 border rounded-lg">
                <input type="number" id="coinPrice" placeholder="سعر الشراء" step="0.01" class="p-3 border rounded-lg">
                <button onclick="addCoin()" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition-colors">
                    إضافة العملة
                </button>
            </div>
        </div>

        <!-- جدول العملات -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">محفظة العملات</h2>
                <div class="flex items-center">
                    <span id="lastUpdate" class="text-sm text-gray-500 ml-4"></span>
                    <button onclick="updatePrices()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        تحديث الأسعار
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">العملة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">سعر الشراء</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر الحالي</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">القيمة الحالية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الربح/الخسارة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النسبة %</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="coinTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                لا توجد عملات في المحفظة. أضف عملة جديدة للبدء.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let portfolios = {};
        let currentPortfolio = null;
        let priceCache = {};
        let updateInterval;

        // تحميل البيانات عند بدء التشغيل
        window.onload = function() {
            loadPortfolios();
            createDefaultPortfolio();
        };

        // تحميل المحافظ من الذاكرة
        function loadPortfolios() {
            const saved = JSON.parse(localStorage.getItem('cryptoPortfolios') || '{}');
            portfolios = saved;
            updatePortfolioSelect();
        }

        // حفظ المحافظ في الذاكرة
        function savePortfolios() {
            localStorage.setItem('cryptoPortfolios', JSON.stringify(portfolios));
        }

        // إنشاء محفظة افتراضية
        function createDefaultPortfolio() {
            if (Object.keys(portfolios).length === 0) {
                const defaultId = 'portfolio_1';
                const initialValue = parseFloat(prompt('أدخل إجمالي الاستثمار الابتدائي (اختياري، اتركه فارغًا ليبدأ من 0):') || '0');
                if (isNaN(initialValue) || initialValue < 0) {
                    alert('القيمة الابتدائية يجب أن تكون رقمًا صالحًا أو صفر');
                    return createDefaultPortfolio(); // إعادة المحاولة
                }
                portfolios[defaultId] = {
                    name: 'المحفظة الرئيسية',
                    coins: {},
                    created: new Date().toISOString(),
                    initialValue: initialValue
                };
                currentPortfolio = defaultId;
                savePortfolios();
                updatePortfolioSelect();
                document.getElementById('portfolioSelect').value = defaultId;
                document.getElementById('initialInvestmentInput').value = initialValue;
            } else {
                currentPortfolio = Object.keys(portfolios)[0];
                document.getElementById('portfolioSelect').value = currentPortfolio;
                document.getElementById('initialInvestmentInput').value = portfolios[currentPortfolio].initialValue || '';
            }
            displayCoins();
        }

        // إنشاء محفظة جديدة
        function createPortfolio() {
            const name = prompt('اسم المحفظة الجديدة:');
            if (name && name.trim()) {
                const initialValue = parseFloat(prompt('أدخل إجمالي الاستثمار الابتدائي (اختياري، اتركه فارغًا ليبدأ من 0):') || '0');
                if (isNaN(initialValue) || initialValue < 0) {
                    alert('القيمة الابتدائية يجب أن تكون رقمًا صالحًا أو صفر');
                    return;
                }
                const id = 'portfolio_' + Date.now();
                portfolios[id] = {
                    name: name.trim(),
                    coins: {},
                    created: new Date().toISOString(),
                    initialValue: initialValue
                };
                currentPortfolio = id;
                savePortfolios();
                updatePortfolioSelect();
                document.getElementById('portfolioSelect').value = id;
                document.getElementById('initialInvestmentInput').value = initialValue;
                displayCoins();
            }
        }

        // حذف المحفظة
        function deletePortfolio() {
            if (!currentPortfolio) return;
            
            if (Object.keys(portfolios).length === 1) {
                alert('لا يمكن حذف المحفظة الوحيدة المتبقية');
                return;
            }
            
            const portfolioName = portfolios[currentPortfolio].name;
            if (confirm(`هل أنت متأكد من حذف محفظة "${portfolioName}"؟`)) {
                delete portfolios[currentPortfolio];
                currentPortfolio = Object.keys(portfolios)[0] || null;
                savePortfolios();
                updatePortfolioSelect();
                document.getElementById('initialInvestmentInput').value = currentPortfolio ? portfolios[currentPortfolio].initialValue || '' : '';
                if (currentPortfolio) {
                    document.getElementById('portfolioSelect').value = currentPortfolio;
                    displayCoins();
                }
            }
        }

        // تحديث قائمة المحافظ
        function updatePortfolioSelect() {
            const select = document.getElementById('portfolioSelect');
            select.innerHTML = '<option value="">اختر المحفظة</option>';
            
            Object.keys(portfolios).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = portfolios[id].name;
                select.appendChild(option);
            });
        }

        // تبديل المحفظة
        function switchPortfolio() {
            const selected = document.getElementById('portfolioSelect').value;
            if (selected && portfolios[selected]) {
                currentPortfolio = selected;
                document.getElementById('initialInvestmentInput').value = portfolios[currentPortfolio].initialValue || '';
                displayCoins();
            } else {
                document.getElementById('initialInvestmentInput').value = '';
            }
        }

        // إضافة عملة جديدة
        function addCoin() {
            if (!currentPortfolio) {
                alert('يرجى اختيار محفظة أولاً');
                return;
            }

            const symbol = document.getElementById('coinSymbol').value.toUpperCase().trim();
            const amount = parseFloat(document.getElementById('coinAmount').value);
            const buyPrice = parseFloat(document.getElementById('coinPrice').value);

            if (!symbol || isNaN(amount) || isNaN(buyPrice) || amount <= 0 || buyPrice <= 0) {
                alert('يرجى ملء جميع الحقول بقيم صالحة');
                return;
            }

            const portfolio = portfolios[currentPortfolio];

            if (portfolio.coins[symbol]) {
                // إذا كانت العملة موجودة، نحدث البيانات
                const existing = portfolio.coins[symbol];
                const totalValue = (existing.amount * existing.buyPrice) + (amount * buyPrice);
                const totalAmount = existing.amount + amount;
                portfolio.coins[symbol] = {
                    amount: totalAmount,
                    buyPrice: totalValue / totalAmount, // متوسط السعر
                    currentPrice: existing.currentPrice || 0
                };
            } else {
                portfolio.coins[symbol] = {
                    amount: amount,
                    buyPrice: buyPrice,
                    currentPrice: 0
                };
            }

            savePortfolios();
            displayCoins();
            
            // مسح الحقول
            document.getElementById('coinSymbol').value = '';
            document.getElementById('coinAmount').value = '';
            document.getElementById('coinPrice').value = '';
            
            // تحديث السعر للعملة الجديدة
            updateCoinPrice(symbol);
        }

        // حذف عملة
        function removeCoin(symbol) {
            if (!currentPortfolio) return;
            
            if (confirm(`هل أنت متأكد من حذف ${symbol}؟`)) {
                delete portfolios[currentPortfolio].coins[symbol];
                savePortfolios();
                displayCoins();
            }
        }

        // عرض العملات
        function displayCoins() {
            if (!currentPortfolio || !portfolios[currentPortfolio]) {
                document.getElementById('coinTableBody').innerHTML = 
                    '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">يرجى اختيار محفظة صالحة</td></tr>';
                return;
            }

            const coins = portfolios[currentPortfolio].coins;
            const tbody = document.getElementById('coinTableBody');
            
            if (Object.keys(coins).length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">لا توجد عملات في المحفظة</td></tr>';
                updateSummary();
                return;
            }

            tbody.innerHTML = '';
            
            Object.keys(coins).forEach(symbol => {
                const coin = coins[symbol];
                const currentValue = coin.amount * coin.currentPrice;
                const investedValue = coin.amount * coin.buyPrice;
                const pnl = currentValue - investedValue;
                const pnlPercent = investedValue > 0 ? (pnl / investedValue * 100) : 0;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const priceChangeClass = coin.currentPrice >= coin.buyPrice ? 'price-up' : 'price-down';
                const pnlClass = pnl >= 0 ? 'text-green-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${symbol}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${coin.amount.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${coin.buyPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${priceChangeClass}">
                        ${coin.currentPrice > 0 ? 
                            `$${coin.currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}` : 
                            '<span class="pulse">جاري التحديث...</span>'
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${currentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${pnlClass}">
                        $${pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${pnlClass}">
                        ${pnl >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="removeCoin('${symbol}')" 
                                class="text-red-600 hover:text-red-900 transition-colors">
                            حذف
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updateSummary();
        }

        // تحديث الملخص
        function updateSummary() {
            if (!currentPortfolio) return;
            
            const portfolio = portfolios[currentPortfolio];
            const coins = portfolio.coins;
            
            let totalCurrentValue = 0;
            let totalCoinInvestment = 0;
            
            Object.keys(coins).forEach(symbol => {
                const coin = coins[symbol];
                totalCurrentValue += coin.amount * coin.currentPrice;
                totalCoinInvestment += coin.amount * coin.buyPrice;
            });
            
            // حساب الأداء العام بناءً على القيمة الابتدائية الثابتة
            const initialValue = portfolio.initialValue || 0;
            const coinPerformance = totalCurrentValue - totalCoinInvestment;
            const overallPerformance = totalCurrentValue - initialValue;
            const overallPerformancePercent = initialValue > 0 ? (overallPerformance / initialValue * 100) : 0;
            
            // تحديث العناصر
            document.getElementById('totalValue').textContent = `$${totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('initialInvestment').textContent = `$${initialValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            
            const coinPerfElement = document.getElementById('coinPerformance');
            const overallPerfPercentElement = document.getElementById('overallPerformancePercent');
            
            coinPerfElement.textContent = `$${coinPerformance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            overallPerfPercentElement.textContent = `${overallPerformance >= 0 ? '+' : ''}${overallPerformancePercent.toFixed(2)}%`;
            
            const coinPerfClass = coinPerformance >= 0 ? 'text-green-600' : 'text-red-600';
            const overallPerfClass = overallPerformance >= 0 ? 'text-green-600' : 'text-red-600';
            
            coinPerfElement.className = `text-3xl font-bold ${coinPerfClass}`;
            overallPerfPercentElement.className = `text-3xl font-bold ${overallPerfClass}`;
        }

        // تحديث الاستثمار الابتدائي يدويًا
        function updateInitialInvestment() {
            if (!currentPortfolio) {
                alert('يرجى اختيار محفظة أولاً');
                return;
            }

            const initialInvestmentInput = parseFloat(document.getElementById('initialInvestmentInput').value);
            if (isNaN(initialInvestmentInput) || initialInvestmentInput < 0) {
                alert('يرجى إدخال قيمة صالحة للاستثمار الابتدائي');
                return;
            }

            portfolios[currentPortfolio].initialValue = initialInvestmentInput;
            savePortfolios();
            displayCoins(); // يعيد عرض الجدول ويحدث الملخص
            document.getElementById('initialInvestmentInput').value = ''; // مسح الحقل
        }

        // تحديث سعر عملة واحدة
        async function updateCoinPrice(symbol) {
            if (!currentPortfolio) return;
            
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${getCoinId(symbol)}&vs_currencies=usd&include_24hr_change=true`);
                const data = await response.json();
                
                const coinId = getCoinId(symbol);
                if (data[coinId] && data[coinId].usd) {
                    portfolios[currentPortfolio].coins[symbol].currentPrice = data[coinId].usd;
                    savePortfolios();
                    displayCoins();
                }
            } catch (error) {
                console.error(`خطأ في تحديث سعر ${symbol}:`, error);
            }
        }

        // تحديث جميع الأسعار
        async function updatePrices() {
            if (!currentPortfolio) return;
            
            const coins = portfolios[currentPortfolio].coins;
            const symbols = Object.keys(coins);
            
            if (symbols.length === 0) return;
            
            // إظهار حالة التحديث
            document.getElementById('lastUpdate').innerHTML = '<div class="loading-spinner"></div>جاري التحديث...';
            
            try {
                const coinIds = symbols.map(symbol => getCoinId(symbol)).join(',');
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coinIds}&vs_currencies=usd&include_24hr_change=true`);
                const data = await response.json();
                
                symbols.forEach(symbol => {
                    const coinId = getCoinId(symbol);
                    if (data[coinId] && data[coinId].usd) {
                        coins[symbol].currentPrice = data[coinId].usd;
                    }
                });
                
                savePortfolios();
                displayCoins();
                
                const now = new Date();
                document.getElementById('lastUpdate').textContent = `آخر تحديث: ${now.toLocaleTimeString('ar-SA')}`;
                
            } catch (error) {
                console.error('خطأ في تحديث الأسعار:', error);
                document.getElementById('lastUpdate').textContent = 'خطأ في تحديث الأسعار';
            }
        }

        // تحويل رمز العملة إلى معرف CoinGecko
        function getCoinId(symbol) {
            const coinMap = {
                'BTC': 'bitcoin',
                'ETH': 'ethereum',
                'USDT': 'tether',
                'SOL': 'solana',
                'SUI': 'sui',
                'AVAX': 'avalanche-2',
                'SEI': 'sei-network',
                'RENDER': 'render-token',
                'ICP': 'internet-computer',
                'FET': 'fetch-ai',
                'BNB': 'binancecoin',
                'XRP': 'ripple',
                'ADA': 'cardano',
                'DOGE': 'dogecoin',
                'DOT': 'polkadot',
                'MATIC': 'matic-network',
                'SHIB': 'shiba-inu',
                'LTC': 'litecoin',
                'UNI': 'uniswap',
                'LINK': 'chainlink',
                'ATOM': 'cosmos',
                'XLM': 'stellar',
                'BCH': 'bitcoin-cash',
                'ALGO': 'algorand',
                'VET': 'vechain',
                'FIL': 'filecoin',
                'TRX': 'tron',
                'ETC': 'ethereum-classic',
                'XMR': 'monero',
                'APE': 'apecoin',
                'NEAR': 'near',
                'HBAR': 'hedera-hashgraph',
                'FLOW': 'flow',
                'MANA': 'decentraland',
                'SAND': 'the-sandbox',
                'THETA': 'theta-token',
                'XTZ': 'tezos',
                'EGLD': 'elrond-erd-2',
                'USDC': 'usd-coin',
                'BUSD': 'binance-usd',
                'DAI': 'dai',
                'PEPE': 'pepe',
                'ARB': 'arbitrum',
                'OP': 'optimism'
            };
            
            return coinMap[symbol] || symbol.toLowerCase();
        }

        // تحديث تلقائي كل 30 ثانية
        setInterval(() => {
            if (currentPortfolio && Object.keys(portfolios[currentPortfolio].coins).length > 0) {
                updatePrices();
            }
        }, 30000);

        // تحديث أولي للأسعار بعد 2 ثانية
        setTimeout(() => {
            if (currentPortfolio) {
                updatePrices();
            }
        }, 2000);
    </script>
</body>
</html>
