<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متتبع محفظة العملات الرقمية</title>
    <script src="https://cdn.tailwindcss.com"></script> <!-- للاختبار فقط، استبدله في الإنتاج -->
    <style>
        body { font-family: 'Arial', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-glow {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card-glow:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: right;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ... (الجزء العلوي من HTML يبقى كما هو حتى <script>) ... -->

    <script>
        let portfolios = {};
        let currentPortfolio = null;
        let priceCache = {};
        let updateInterval;

        window.onload = function() {
            loadPortfolios();
            createDefaultPortfolio();
        };

        function loadPortfolios() {
            const saved = JSON.parse(localStorage.getItem('cryptoPortfolios') || '{}');
            portfolios = saved;
            updatePortfolioSelect();
        }

        function savePortfolios() {
            localStorage.setItem('cryptoPortfolios', JSON.stringify(portfolios));
        }

        function createDefaultPortfolio() {
            if (Object.keys(portfolios).length === 0) {
                const defaultId = 'portfolio_1';
                const initialValue = parseFloat(prompt('أدخل إجمالي الاستثمار الابتدائي (اختياري، اتركه فارغًا ليبدأ من 0):') || '0');
                if (isNaN(initialValue) || initialValue < 0) {
                    alert('القيمة الابتدائية يجب أن تكون رقمًا صالحًا أو صفر');
                    return createDefaultPortfolio();
                }
                portfolios[defaultId] = {
                    name: 'المحفظة الرئيسية',
                    coins: {},
                    created: new Date().toISOString(),
                    initialValue: initialValue
                };
                currentPortfolio = defaultId;
                savePortfolios();
                updatePortfolioSelect();
                document.getElementById('portfolioSelect').value = defaultId;
                document.getElementById('initialInvestmentInput').value = initialValue;
            } else {
                currentPortfolio = Object.keys(portfolios)[0];
                document.getElementById('portfolioSelect').value = currentPortfolio;
                document.getElementById('initialInvestmentInput').value = portfolios[currentPortfolio].initialValue || '';
            }
            displayCoins();
            updateAggregatedPerformance();
        }

        function createPortfolio() {
            const name = prompt('اسم المحفظة الجديدة:');
            if (name && name.trim()) {
                const initialValue = parseFloat(prompt('أدخل إجمالي الاستثمار الابتدائي (اختياري، اتركه فارغًا ليبدأ من 0):') || '0');
                if (isNaN(initialValue) || initialValue < 0) {
                    alert('القيمة الابتدائية يجب أن تكون رقمًا صالحًا أو صفر');
                    return;
                }
                const id = 'portfolio_' + Date.now();
                portfolios[id] = {
                    name: name.trim(),
                    coins: {},
                    created: new Date().toISOString(),
                    initialValue: initialValue
                };
                currentPortfolio = id;
                savePortfolios();
                updatePortfolioSelect();
                document.getElementById('portfolioSelect').value = id;
                document.getElementById('initialInvestmentInput').value = initialValue;
                displayCoins();
                updateAggregatedPerformance();
            }
        }

        function deletePortfolio() {
            if (!currentPortfolio) return;
            if (Object.keys(portfolios).length === 1) {
                alert('لا يمكن حذف المحفظة الوحيدة المتبقية');
                return;
            }
            const portfolioName = portfolios[currentPortfolio].name;
            if (confirm(`هل أنت متأكد من حذف محفظة "${portfolioName}"؟`)) {
                delete portfolios[currentPortfolio];
                currentPortfolio = Object.keys(portfolios)[0] || null;
                savePortfolios();
                updatePortfolioSelect();
                document.getElementById('initialInvestmentInput').value = currentPortfolio ? portfolios[currentPortfolio].initialValue || '' : '';
                if (currentPortfolio) {
                    document.getElementById('portfolioSelect').value = currentPortfolio;
                    displayCoins();
                }
                updateAggregatedPerformance();
            }
        }

        function updatePortfolioSelect() {
            const select = document.getElementById('portfolioSelect');
            select.innerHTML = '<option value="">اختر المحفظة</option>';
            Object.keys(portfolios).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = portfolios[id].name;
                select.appendChild(option);
            });
        }

        function switchPortfolio() {
            const selected = document.getElementById('portfolioSelect').value;
            if (selected && portfolios[selected]) {
                currentPortfolio = selected;
                document.getElementById('initialInvestmentInput').value = portfolios[currentPortfolio].initialValue || '';
                displayCoins();
            } else {
                document.getElementById('initialInvestmentInput').value = '';
            }
        }

        function addCoin() {
            if (!currentPortfolio) {
                alert('يرجى اختيار محفظة أولاً');
                return;
            }
            const symbol = document.getElementById('coinSymbol').value.toUpperCase().trim();
            const amount = parseFloat(document.getElementById('coinAmount').value);
            const buyPrice = parseFloat(document.getElementById('coinPrice').value);
            if (!symbol || isNaN(amount) || isNaN(buyPrice) || amount <= 0 || buyPrice <= 0) {
                alert('يرجى ملء جميع الحقول بقيم صالحة');
                return;
            }
            const portfolio = portfolios[currentPortfolio];
            if (portfolio.coins[symbol]) {
                const existing = portfolio.coins[symbol];
                const totalValue = (existing.amount * existing.buyPrice) + (amount * buyPrice);
                const totalAmount = existing.amount + amount;
                portfolio.coins[symbol] = {
                    amount: totalAmount,
                    buyPrice: totalValue / totalAmount,
                    currentPrice: existing.currentPrice || 0
                };
            } else {
                portfolio.coins[symbol] = {
                    amount: amount,
                    buyPrice: buyPrice,
                    currentPrice: 0
                };
            }
            savePortfolios();
            displayCoins();
            updateAggregatedPerformance();
            document.getElementById('coinSymbol').value = '';
            document.getElementById('coinAmount').value = '';
            document.getElementById('coinPrice').value = '';
            updateCoinPrice(symbol);
        }

        function removeCoin(symbol) {
            if (!currentPortfolio) return;
            if (confirm(`هل أنت متأكد من حذف ${symbol}؟`)) {
                delete portfolios[currentPortfolio].coins[symbol];
                savePortfolios();
                displayCoins();
                updateAggregatedPerformance();
            }
        }

        function displayCoins() {
            if (!currentPortfolio || !portfolios[currentPortfolio]) {
                document.getElementById('coinTableBody').innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">يرجى اختيار محفظة صالحة</td></tr>';
                updateSummary();
                return;
            }
            const coins = portfolios[currentPortfolio].coins;
            const tbody = document.getElementById('coinTableBody');
            if (Object.keys(coins).length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">لا توجد عملات في المحفظة</td></tr>';
                updateSummary();
                return;
            }
            tbody.innerHTML = '';
            Object.keys(coins).forEach(symbol => {
                const coin = coins[symbol];
                const currentValue = coin.amount * coin.currentPrice;
                const investedValue = coin.amount * coin.buyPrice;
                const pnl = currentValue - investedValue;
                const pnlPercent = investedValue > 0 ? (pnl / investedValue * 100) : 0;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const priceChangeClass = coin.currentPrice >= coin.buyPrice ? 'price-up' : 'price-down';
                const pnlClass = pnl >= 0 ? 'text-green-600' : 'text-red-600';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${symbol}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${coin.amount.toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${coin.buyPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${priceChangeClass}">
                        ${coin.currentPrice > 0 ? 
                            `$${coin.currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}` : 
                            '<span class="pulse">جاري التحديث...</span>'
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${currentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${pnlClass}">
                        $${pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${pnlClass}">
                        ${pnl >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editCoin('${symbol}')" class="text-yellow-600 hover:text-yellow-900 mr-2 transition-colors">تعديل</button>
                        <button onclick="removeCoin('${symbol}')" class="text-red-600 hover:text-red-900 transition-colors">حذف</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            updateSummary();
            updateAggregatedPerformance();
        }

        function updateSummary() {
            if (!currentPortfolio) return;
            const portfolio = portfolios[currentPortfolio];
            const coins = portfolio.coins;
            let totalCurrentValue = 0;
            let totalCoinInvestment = 0;
            Object.keys(coins).forEach(symbol => {
                const coin = coins[symbol];
                totalCurrentValue += coin.amount * coin.currentPrice;
                totalCoinInvestment += coin.amount * coin.buyPrice;
            });
            const initialValue = portfolio.initialValue || 0;
            const coinPerformance = totalCurrentValue - totalCoinInvestment;
            const overallPerformance = totalCurrentValue - initialValue;
            const overallPerformancePercent = initialValue > 0 ? (overallPerformance / initialValue * 100) : 0;
            document.getElementById('totalValue').textContent = `$${totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('initialInvestment').textContent = `$${initialValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            const coinPerfElement = document.getElementById('coinPerformance');
            const overallPerfPercentElement = document.getElementById('overallPerformancePercent');
            coinPerfElement.textContent = `$${coinPerformance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            overallPerfPercentElement.textContent = `${overallPerformance >= 0 ? '+' : ''}${overallPerformancePercent.toFixed(2)}%`;
            const coinPerfClass = coinPerformance >= 0 ? 'text-green-600' : 'text-red-600';
            const overallPerfClass = overallPerformance >= 0 ? 'text-green-600' : 'text-red-600';
            coinPerfElement.className = `text-3xl font-bold ${coinPerfClass}`;
            overallPerfPercentElement.className = `text-3xl font-bold ${overallPerfClass}`;
        }

        function updateInitialInvestment() {
            if (!currentPortfolio) {
                alert('يرجى اختيار محفظة أولاً');
                return;
            }
            const initialInvestmentInput = parseFloat(document.getElementById('initialInvestmentInput').value);
            if (isNaN(initialInvestmentInput) || initialInvestmentInput < 0) {
                alert('يرجى إدخال قيمة صالحة للاستثمار الابتدائي');
                return;
            }
            portfolios[currentPortfolio].initialValue = initialInvestmentInput;
            savePortfolios();
            displayCoins();
            document.getElementById('initialInvestmentInput').value = '';
        }

        function getBinanceSymbol(symbol) {
            const symbolMap = {
                'BTC': 'BTCUSDT',
                'ETH': 'ETHUSDT',
                'USDT': 'BTCUSDT', // تغيير USDTUSDT إلى رمز صالح (مثال BTCUSDT كبديل مؤقت)
                'SOL': 'SOLUSDT',
                'SUI': 'SUIUSDT',
                'AVAX': 'AVAXUSDT',
                'SEI': 'SEIUSDT',
                'RENDER': 'RENDERUSDT',
                'ICP': 'ICPUSDT',
                'FET': 'FETUSDT',
                'BNB': 'BNBUSDT',
                'XRP': 'XRPUSDT',
                'ADA': 'ADAUSDT',
                'DOGE': 'DOGEUSDT',
                'DOT': 'DOTUSDT',
                'MATIC': 'MATICUSDT',
                'SHIB': 'SHIBUSDT',
                'LTC': 'LTCUSDT',
                'UNI': 'UNIUSDT',
                'LINK': 'LINKUSDT',
                'ATOM': 'ATOMUSDT',
                'XLM': 'XLMUSDT',
                'BCH': 'BCHUSDT',
                'ALGO': 'ALGOUSDT',
                'VET': 'VETUSDT',
                'FIL': 'FILUSDT',
                'TRX': 'TRXUSDT',
                'ETC': 'ETCUSDT',
                'XMR': 'XMRUSDT',
                'APE': 'APEUSDT',
                'NEAR': 'NEARUSDT',
                'HBAR': 'HBARUSDT',
                'FLOW': 'FLOWUSDT',
                'MANA': 'MANAUSDT',
                'SAND': 'SANDUSDT',
                'THETA': 'THETAUSDT',
                'XTZ': 'XTZUSDT',
                'EGLD': 'EGLDUSDT',
                'USDC': 'USDCUSDT',
                'BUSD': 'BUSDUSDT',
                'DAI': 'DAIUSDT',
                'PEPE': 'PEPEUSDT',
                'ARB': 'ARBUSDT',
                'OP': 'OPUSDT'
            };
            return symbolMap[symbol] || (symbol === 'USDT' ? 'BTCUSDT' : `${symbol}USDT`); // معالجة خاصة لـ USDT
        }

        async function updateCoinPrice(symbol) {
            if (!currentPortfolio) return;
            const binanceSymbol = getBinanceSymbol(symbol);
            if (!binanceSymbol || binanceSymbol === 'USDTUSDT') return; // تجنب الرموز غير الصالحة
            try {
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; // بروكسي مؤقت للتعامل مع CORS
                const response = await fetch(`${proxyUrl}https://api.binance.com/api/v3/ticker/price?symbol=${binanceSymbol}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (data.price) {
                    portfolios[currentPortfolio].coins[symbol].currentPrice = parseFloat(data.price);
                    savePortfolios();
                    displayCoins();
                } else {
                    console.error(`خطأ في جلب سعر ${symbol}:`, data);
                }
            } catch (error) {
                console.error(`خطأ في تحديث سعر ${symbol}:`, error);
            }
        }

        async function updatePrices() {
            if (!currentPortfolio) return;
            const coins = portfolios[currentPortfolio].coins;
            const symbols = Object.keys(coins);
            if (symbols.length === 0) {
                document.getElementById('lastUpdate').textContent = 'لا توجد عملات لتحديث الأسعار';
                return;
            }
            document.getElementById('lastUpdate').innerHTML = '<div class="loading-spinner"></div>جاري التحديث...';
            let retries = 2;
            while (retries >= 0) {
                try {
                    for (const symbol of symbols) {
                        const binanceSymbol = getBinanceSymbol(symbol);
                        if (!binanceSymbol || binanceSymbol === 'USDTUSDT') continue; // تخطي الرموز غير الصالحة
                        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                        const response = await fetch(`${proxyUrl}https://api.binance.com/api/v3/ticker/price?symbol=${binanceSymbol}`);
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        const data = await response.json();
                        if (data.price) {
                            coins[symbol].currentPrice = parseFloat(data.price);
                        } else {
                            console.warn(`فشل تحديث سعر ${symbol}:`, data);
                            coins[symbol].currentPrice = 0;
                        }
                    }
                    savePortfolios();
                    displayCoins();
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = `آخر تحديث: ${now.toLocaleTimeString('ar-SA')}`;
                    return;
                } catch (error) {
                    console.error('خطأ في تحديث الأسعار:', error);
                    retries--;
                    if (retries >= 0) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } else {
                        document.getElementById('lastUpdate').textContent = `خطأ في تحديث الأسعار (محاولات منتهية): ${error.message}`;
                    }
                }
            }
        }

        function editCoin(symbol) {
            const coin = portfolios[currentPortfolio].coins[symbol];
            document.getElementById('editSymbol').value = symbol;
            document.getElementById('editAmount').value = coin.amount;
            document.getElementById('editBuyPrice').value = coin.buyPrice;
            document.getElementById('editModal').style.display = 'flex';
        }

        function saveEdit() {
            const symbol = document.getElementById('editSymbol').value;
            const newAmount = parseFloat(document.getElementById('editAmount').value);
            const newBuyPrice = parseFloat(document.getElementById('editBuyPrice').value);
            if (isNaN(newAmount) || isNaN(newBuyPrice) || newAmount <= 0 || newBuyPrice <= 0) {
                alert('يرجى إدخال قيم صالحة للكمية وسعر الشراء');
                return;
            }
            const portfolio = portfolios[currentPortfolio];
            portfolio.coins[symbol] = {
                amount: newAmount,
                buyPrice: newBuyPrice,
                currentPrice: portfolio.coins[symbol].currentPrice || 0
            };
            savePortfolios();
            displayCoins();
            updateAggregatedPerformance();
            closeModal();
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editAmount').value = '';
            document.getElementById('editBuyPrice').value = '';
        }

        function updateAggregatedPerformance() {
            let totalInitialInvestment = 0;
            let totalCurrentValue = 0;
            Object.keys(portfolios).forEach(id => {
                const portfolio = portfolios[id];
                const coins = portfolio.coins;
                let portfolioCurrentValue = 0;
                Object.keys(coins).forEach(symbol => {
                    const coin = coins[symbol];
                    portfolioCurrentValue += coin.amount * coin.currentPrice;
                });
                totalInitialInvestment += portfolio.initialValue || 0;
                totalCurrentValue += portfolioCurrentValue;
            });
            const aggregatedProfit = totalCurrentValue - totalInitialInvestment;
            document.getElementById('aggregatedInitialInvestment').textContent = `$${totalInitialInvestment.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('aggregatedTotalValue').textContent = `$${totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('aggregatedProfit').textContent = `$${aggregatedProfit.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            const profitClass = aggregatedProfit >= 0 ? 'text-green-600' : 'text-red-600';
            document.getElementById('aggregatedProfit').className = `text-3xl font-bold ${profitClass}`;
        }

        setInterval(() => {
            if (currentPortfolio && Object.keys(portfolios[currentPortfolio].coins).length > 0) {
                updatePrices();
            }
        }, 30000);

        setTimeout(() => {
            if (currentPortfolio) {
                updatePrices();
            }
        }, 2000);
    </script>
</body>
</html>
